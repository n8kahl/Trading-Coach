openapi: 3.1.0
info:
  title: Trading Coach Backend API
  version: "2.2.2"
  description: |
    Fancy Trader endpoints powering GPT integrations.
    Session-aware payloads clamp data when markets are closed (frozen).
servers:
  - url: https://trading-coach-production.up.railway.app
    description: Production

paths:
  /gpt/plan:
    post:
      summary: Return a single trade plan for a symbol
      operationId: postGptPlan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlanRequest'
      responses:
        '200':
          description: Structured plan response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
        '400': { description: Invalid input }
        '404': { description: No plan available }
        '502': { description: Upstream market data unavailable }

  /gpt/scan:
    post:
      summary: Rank trade setups across a universe
      operationId: postGptScan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScanRequest'
      responses:
        '200':
          description: Ranked scan candidates (limit honoured per request)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanPage'
        '400': { description: Invalid input or empty universe }
        '502': { description: Upstream market data unavailable }

  /gpt/finalize:
    post:
      summary: Finalize a planning-mode candidate once live quotes are verified
      operationId: postGptFinalize
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FinalizeRequest'
      responses:
        '200':
          description: Finalization acknowledgement
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinalizeResponse'
        '400': { description: Invalid finalization payload }

  /gpt/chart-url:
    post:
      summary: Build canonical /tv link for a plan
      operationId: postGptChartUrl
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChartUrlRequest'
      responses:
        '200':
          description: Canonical chart URL
          content:
            application/json:
              schema:
                type: object
                required: [interactive]
                properties:
                  interactive:
                    type: string
                    format: uri
                    example: >-
                      https://trading-coach-production.up.railway.app/tv?center_time=latest&direction=long&ema=9,20,50&entry=251.4&focus=plan&interval=5m&plan_id=TSLA-2025-10-15T153000-1&plan_version=1&range=1d&scale_plan=auto&stop=249.8&symbol=TSLA&theme=dark&tp=253.0,254.2,255.6&view=1D
        '400': { description: Validation error (unknown keys or bad types) }

  /api/v1/gpt/chart-layers:
    get:
      summary: Return persisted overlays for a plan
      operationId: getGptChartLayers
      parameters:
        - in: query
          name: plan_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Levels/zones/annotations for plotting
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanLayers'
        '404': { description: Not found }
        '409':
          description: Plan/session timestamp mismatch
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  plan_id: { type: string }
                  plan_as_of: { type: string }
                  layers_as_of: { type: string }

components:
  schemas:

    # ---------- Requests ----------
    PlanRequest:
      type: object
      required: [symbol]
      properties:
        symbol:
          type: string
          description: Ticker symbol to plan
          example: TSLA
        style:
          type: string
          nullable: true
          description: Optional style hint (scalp, intraday, swing, leaps)
          example: intraday
        plan_id:
          type: string
          nullable: true
          description: Force plan refresh for a specific plan id
        simulate_open:
          type: boolean
          default: false
          description: >-
            When true, treats closed sessions as simulated-live for strategy evaluation.
            Also accepts the `X-Simulate-Open: 1` header.
        min_actionability:
          type: number
          format: double
          minimum: 0
          maximum: 1
          nullable: true
          description: >-
            Optional per-request gate for entry selection. When provided, plans with
            entry actionability below this threshold will fall back to a WAIT response.
        must_be_actionable:
          type: boolean
          default: false
          description: >-
            When true, the planner will emit a WAIT plan instead of returning a stale
            entry if no candidate meets `min_actionability` or the style default gate.

    ScanFilters:
      type: object
      properties:
        min_rvol:
          type: number
          minimum: 0
          nullable: true
        exclude:
          type: array
          items:
            type: string
        min_liquidity_rank:
          type: integer
          minimum: 1
          nullable: true

    ScanRequest:
      type: object
      required: [universe, style]
      properties:
        universe:
          oneOf:
            - type: string
              description: A universe token (will be expanded to tickers server-side)
              example: FT-TopLiquidity
            - type: array
              items: { type: string }
              description: Explicit tickers
              example: ["AAPL","MSFT","NVDA"]
        style:
          type: string
          enum: [scalp, intraday, swing, leaps]
        limit:
          type: integer
          default: 20
          minimum: 1
          maximum: 100
        asof_policy:
          type: string
          enum: [live, frozen, live_or_lkg]
          default: live_or_lkg
        filters:
          $ref: '#/components/schemas/ScanFilters'
        cursor:
          type: string
          nullable: true
        simulate_open:
          type: boolean
          default: false
          description: >-
            When true, evaluates the scan as if the market were open even if the
            current session is closed. Also accepts the `X-Simulate-Open: 1` header.

    ChartUrlRequest:
      type: object
      description: >
        The only accepted fields to build a canonical /tv link. All other
        keys (e.g., session_* / market_* / levels) are ignored or rejected.
      required:
        - symbol
        - interval
        - direction
        - entry
        - stop
        - tp
        - ema
        - focus
        - center_time
        - scale_plan
        - view
        - range
        - theme
        - plan_id
        - plan_version
      properties:
        symbol: { type: string, example: TSLA }
        interval: { type: string, example: 5m }
        direction: { type: string, enum: [long, short] }
        entry: { type: number, format: double, example: 251.4 }
        stop: { type: number, format: double, example: 249.8 }
        tp:
          type: array
          description: Target prices in display order
          items: { type: number, format: double }

    FinalizeRequest:
      type: object
      required: [candidate_id, status]
      properties:
        candidate_id:
          type: integer
          description: Identifier returned by planning-mode persistence
        symbol:
          type: string
          nullable: true
          description: Optional symbol for reference/logging
        status:
          type: string
          enum: [finalized, rejected, deferred]
        live_inputs:
          type: object
          additionalProperties: {}
          description: Snapshot of live market inputs used during finalization (IV, spread, OI, etc.)
          default: {}
        selected_contracts:
          type: array
          items: { type: object }
          nullable: true
          description: Contracts approved during finalization (if any)
        reject_reason:
          type: string
          nullable: true
          description: Optional explanation when status = rejected

    FinalizeResponse:
      type: object
      required: [candidate_id, status, updated]
      properties:
        candidate_id: { type: integer }
        status: { type: string, enum: [finalized, rejected, deferred] }
        updated: { type: boolean }
          example: [253.0, 254.2, 255.6]
        ema:
          type: array
          description: EMA periods included on the chart
          items: { type: integer, minimum: 1 }
          example: [9, 20, 50]
        focus: { type: string, enum: [plan], example: plan }
        center_time: { type: string, enum: [latest], example: latest }
        scale_plan: { type: string, enum: [auto], example: auto }
        view: { type: string, example: 1D }
        range: { type: string, example: 1d }
        theme: { type: string, example: dark }
        plan_id: { type: string, example: TSLA-2025-10-15T153000-1 }
        plan_version: { type: integer, minimum: 1, example: 1 }

    # ---------- Scan ----------
    ScanCandidate:
      type: object
      required: [symbol, score, reasons]
      properties:
        symbol: { type: string }
        rank: { type: integer, nullable: true }
        score: { type: number, format: double }
        reasons:
          type: array
          items: { type: string }
        plan_id: { type: string, nullable: true }
        entry: { type: number, format: double, nullable: true }
        stop: { type: number, format: double, nullable: true }
        tps:
          type: array
          items: { type: number, format: double }
        rr_t1: { type: number, format: double, nullable: true }
        confidence: { type: number, format: double, nullable: true }
        chart_url: { type: string, format: uri, nullable: true }
        target_meta:
          type: array
          items: { $ref: '#/components/schemas/TargetMeta' }
        targets_meta:
          type: array
          items: { $ref: '#/components/schemas/TargetMeta' }
        tp_reasons:
          type: array
          items: { $ref: '#/components/schemas/TpReason' }
        structured_plan:
          $ref: '#/components/schemas/StructuredPlan'
          nullable: true
        target_profile:
          $ref: '#/components/schemas/TargetProfile'
          nullable: true
        runner_policy: { type: object, nullable: true }
        snap_trace:
          type: array
          items: { type: string }
          nullable: true
        expected_move: { type: number, format: double, nullable: true }
        remaining_atr: { type: number, format: double, nullable: true }
        em_used: { type: boolean, nullable: true }
        risk_block:
          $ref: '#/components/schemas/RiskBlock'
          nullable: true
        execution_rules:
          $ref: '#/components/schemas/ExecutionRules'
          nullable: true
        confluence:
          type: array
          items: { type: string }
        accuracy_levels:
          type: array
          items: { type: string }
        events:
          $ref: '#/components/schemas/EventsBlock'
          nullable: true
        options: { type: object, nullable: true }
        options_contracts:
          type: array
          items: { $ref: '#/components/schemas/Contract' }
        options_note: { type: string, nullable: true }
        rejected_contracts:
          type: array
          items:
            type: object
            properties:
              symbol: { type: string }
              reason: { type: string }
              message: { type: string, nullable: true }
        entry_distance_pct: { type: number, format: double, nullable: true }
        entry_distance_atr: { type: number, format: double, nullable: true }
        bars_to_trigger: { type: number, format: double, nullable: true }
        actionable_soon: { type: boolean, nullable: true }
        source_paths:
          type: object
          additionalProperties: { type: string }
        planning_snapshot:
          type: object
          nullable: true
          description: Present when the scan runs in planning mode; describes the readiness scoring used by the planning engine.
          properties:
            planning_mode: { type: boolean }
            readiness_score: { type: number, format: double }
            components:
              type: object
              properties:
                probability: { type: number, format: double }
                actionability: { type: number, format: double }
                risk_reward: { type: number, format: double }
            levels:
              type: object
              properties:
                entry: { type: number, format: double }
                invalidation: { type: number, format: double }
                targets:
                  type: array
                  items: { type: number, format: double }
            contract_template: { type: object }
            requires_live_confirmation: { type: boolean }
            missing_live_inputs:
              type: array
              items: { type: string }
            target_meta:
              type: array
              items: { $ref: '#/components/schemas/TargetMeta' }
            runner_policy: { type: object }
            snap_trace:
              type: array
              items: { type: string }
            expected_move: { type: number, format: double, nullable: true }
            remaining_atr: { type: number, format: double, nullable: true }
            chart_params:
              type: object
              properties:
                symbol: { type: string }
                interval: { type: string }
                direction: { type: string }
                entry: { type: string }
                stop: { type: string }
                tp: { type: string }
            direction: { type: string }
            source_paths:
              type: object
              additionalProperties: { type: string }

    ScanPage:
      type: object
      required: [as_of, planning_context, meta, candidates, data_quality]
      properties:
        as_of: { type: string, format: date-time }
        planning_context: { type: string, enum: [live, frozen] }
        banner: { type: string, nullable: true }
        meta:
          type: object
          description: Additional metadata (includes `simulated_open` when simulated live mode is used).
        candidates:
          type: array
          items: { $ref: '#/components/schemas/ScanCandidate' }
        data_quality: { type: object }
        session: { type: object, nullable: true }
        phase: { type: string, enum: [scan], nullable: true }
        count_candidates: { type: integer, nullable: true }
        next_cursor: { type: string, nullable: true }
      example:
        as_of: "2025-10-20T01:00:00Z"
        planning_context: frozen
        banner: "Planning mode — market closed"
        meta:
          planning_mode: true
          run_id: 4123
          snapshot:
            generated_at: "2025-10-20T01:00:00Z"
            symbol_count: 3
          indices_context:
            I:SPX: { close: 4710.5, change_pct: 0.45 }
          universe:
            name: FT-TopLiquidity
            source: planner
            count: 3
        candidates:
          - symbol: AAPL
            rank: 1
            score: 0.82
            rr_t1: 1.6
            entry: 188.42
            stop: 185.9
            tps: [189.8, 191.2, 192.4]
            reasons: ["Readiness 0.82", "Probability 79%", "Risk/Reward 1.95"]
            target_meta:
              - label: TP1
                prob_touch: 0.62
                rr_multiple: 1.6
            targets_meta:
              - label: TP1
                prob_touch: 0.62
                rr_multiple: 1.6
            tp_reasons:
              - label: TP1
                reason: "Snapped to VAH"
            chart_url: "https://trading-coach-production.up.railway.app/tv?...&symbol=AAPL"
            runner_policy:
              fraction: 0.2
              atr_multiple: 0.8
            snap_trace:
              - "tp1:189.20->189.80 via VAH"
            expected_move: 4.5
            remaining_atr: 3.1
            em_used: true
            risk_block:
              risk_points: 2.52
            execution_rules:
              trigger: "Trigger on acceptance above VAH."
            confluence: ["EMA stack"]
            accuracy_levels: ["EM cap"]
            structured_plan:
              plan_id: AAPL-INTRADAY-20251017
              entry: { type: limit, level: 188.42 }
              stop: 185.9
              targets: [189.8, 191.2, 192.4]
              probabilities: { tp1: 0.62 }
            target_profile:
              entry: 188.42
              stop: 185.9
              targets: [189.8, 191.2, 192.4]
            options_contracts: []
            options_note: null
            rejected_contracts: []
            source_paths:
              entry: geometry_engine
              stop: geometry_engine
            planning_snapshot:
              planning_mode: true
              readiness_score: 0.82
              target_meta:
                - prob_touch: 0.62
                  rr_multiple: 1.6
              runner_policy:
                fraction: 0.2
              chart_params:
                symbol: AAPL
                interval: 5m
                direction: long
                entry: "188.42"
                stop: "185.90"
                tp: "189.80,191.20,192.40"
        data_quality:
          planning_mode: true
          series_present: true
          indices_present: true
          snapshot:
            generated_at: "2025-10-20T01:00:00Z"
            symbol_count: 3
        session:
          planning_mode: true
          universe: FT-TopLiquidity
          symbols: [AAPL, MSFT, NVDA]
        phase: scan
        count_candidates: 3
        next_cursor: null

    # ---------- Plans ----------
    Contract:
      type: object
      required: [symbol]
      properties:
        symbol: { type: string }
        delta:  { type: number }
        oi:     { type: integer }
        spread: { type: number, description: "fraction e.g. 0.05 = 5%" }
        ivp:    { type: number, nullable: true }
        expiry: { type: string, nullable: true }

    PlanLayers:
      type: object
      required: [as_of, meta]
      properties:
        as_of: { type: string, format: date-time }
        levels:
          type: array
          items:
            type: object
            properties:
              price: { type: number, format: double }
              label: { type: string }
              kind:  { type: string }
        zones:
          type: array
          items:
            type: object
            properties:
              top: { type: number, format: double }
              bottom: { type: number, format: double }
              label: { type: string }
        annotations:
          type: array
          items:
            type: object
            properties:
              time: { type: string }
              text: { type: string }
        meta:
          type: object
          properties:
            symbol: { type: string }
            interval: { type: string }
            precision: { type: integer }

    LevelUsage:
      type: object
      properties:
        role: { type: string }
        label: { type: string, nullable: true }
        price: { type: number, format: double }
        distance: { type: number, format: double, nullable: true }
        source: { type: string, nullable: true }

    KeyLevelsUsed:
      type: object
      properties:
        session:
          type: array
          items: { $ref: '#/components/schemas/LevelUsage' }
        structural:
          type: array
          items: { $ref: '#/components/schemas/LevelUsage' }

    RiskBlock:
      type: object
      properties:
        risk_points: { type: number, format: double, nullable: true }
        risk_percent: { type: number, format: double, nullable: true }
        reward_to_target:
          type: object
          additionalProperties: { type: number, format: double }
        atr_stop_multiple: { type: number, format: double, nullable: true }
        atr_value: { type: number, format: double, nullable: true }
        expected_move: { type: number, format: double, nullable: true }
        expected_move_fraction:
          type: object
          additionalProperties: { type: number, format: double }
        runner_trail_multiple: { type: number, format: double, nullable: true }

    ExecutionRules:
      type: object
      properties:
        trigger: { type: string, nullable: true }
        invalidation: { type: string, nullable: true }
        scale: { type: string, nullable: true }
        reload: { type: string, nullable: true }

    TargetMeta:
      type: object
      properties:
        label: { type: string }
        prob_touch: { type: number, format: double }
        prob_touch_raw:
          type: number
          format: double
          description: Raw model probability prior to calibration.
        prob_touch_calibrated:
          type: number
          format: double
          description: Calibrated probability mapped from reliability tables.
        distance: { type: number, format: double }
        optional: { type: boolean }
        em_fraction: { type: number, format: double }
        em_basis: { type: number, format: double }
        mfe_quantile: { type: string }
        mfe_ratio: { type: number, format: double }
        rr_multiple: { type: number, format: double, description: "Risk/reward multiple to this target." }

    TpReason:
      type: object
      properties:
        label: { type: string }
        reason: { type: string }
        source: { type: string, nullable: true }

    PlanResponse:
      type: object
      required: [plan_id, version, trade_detail, symbol]
      properties:
        plan_id: { type: string }
        version: { type: integer, minimum: 1 }
        trade_detail: { type: string, format: uri }
        warnings:
          type: array
          items: { type: string }
        planning_context: { type: string, enum: [live, frozen] }
        symbol: { type: string }
        style: { type: string, nullable: true }
        bias: { type: string, nullable: true }
        setup: { type: string, nullable: true }
        entry_anchor: { type: string, nullable: true }
        entry_actionability: { type: number, format: double, nullable: true }
        actionable_now: { type: boolean, nullable: true }
        actionable_soon: { type: boolean, nullable: true }
        waiting_for:
          type: string
          nullable: true
          description: >-
            Human-readable trigger when the plan is in a WAIT state. When present the
            response omits fixed entry/stop values and relies on this condition.
        actionability_gate: { type: number, format: double, nullable: true }
        entry: { type: number, format: double, nullable: true }
        stop: { type: number, format: double, nullable: true }
        targets:
          type: array
          items: { type: number, format: double }
        target_meta:
          type: array
          items: { $ref: '#/components/schemas/TargetMeta' }
        targets_meta:
          type: array
          items: { $ref: '#/components/schemas/TargetMeta' }
          description: Alias of `target_meta` for clients that expect pluralised naming.
        rr_to_t1: { type: number, format: double, nullable: true }
        confidence: { type: number, format: double, nullable: true }
        confidence_factors:
          type: array
          items: { type: string }
        notes: { type: string, nullable: true }
        relevant_levels:
          type: object
          additionalProperties: { type: number, format: double }
        expected_move_basis: { type: string, nullable: true }
        sentiment: { type: object, nullable: true }
        events: { $ref: '#/components/schemas/EventsBlock' }
        earnings: { $ref: '#/components/schemas/EarningsBlock' }
        charts_params: { type: object }
        chart_url: { type: string, format: uri, nullable: true }
        strategy_id: { type: string, nullable: true }
        description: { type: string, nullable: true }
        score: { type: number, format: double, nullable: true }
        plan: { type: object, nullable: true }
        structured_plan: { $ref: '#/components/schemas/StructuredPlan' }
        target_profile: { $ref: '#/components/schemas/TargetProfile' }
        charts:
          type: object
          nullable: true
          description: Chart payload (includes `live=1` / `last_update` when live or simulated-live contexts apply).
        key_levels:
          type: object
          additionalProperties: { type: number, format: double }
        key_levels_used:
          $ref: '#/components/schemas/KeyLevelsUsed'
          nullable: true
        market_snapshot: { type: object, nullable: true }
        features: { type: object, nullable: true }
        options: { type: object, nullable: true }
        calc_notes: { type: object, nullable: true }
        htf:
          type: object
          properties:
            bias: { type: string }
            snapped_targets:
              type: array
              items: { type: string }
        decimals: { type: integer, nullable: true }
        data_quality:
          type: object
          properties:
            series_present: { type: boolean }
            iv_present: { type: boolean }
            earnings_present: { type: boolean }
            expected_move: { type: number, format: double }
            remaining_atr: { type: number, format: double }
            em_used: { type: boolean }
        debug: { type: object, nullable: true }
        runner: { type: object, nullable: true }
        runner_policy: { type: object, nullable: true }
        snap_trace:
          type: array
          items: { type: string }
          nullable: true
        expected_move: { type: number, format: double, nullable: true }
        remaining_atr: { type: number, format: double, nullable: true }
        em_used: { type: boolean, nullable: true }
        calibration_meta:
          type: object
          nullable: true
          description: Reliability bins and scoring metadata backing probability calibration.
        updated_from_version: { type: integer, nullable: true }
        update_reason: { type: string, nullable: true }
        market: { type: object, nullable: true }
        data: { type: object, nullable: true }
        session_state: { $ref: '#/components/schemas/SessionState' }
        # New required outputs for parity with prompt
        confluence:
          type: array
          items: { type: string }
        accuracy_levels:
          type: array
          items: { type: string }
          nullable: true
          description: Indicator-specific accuracy or cap annotations delivered by the geometry engine.
        tp_reasons:
          type: array
          items: { $ref: '#/components/schemas/TpReason' }
        options_contracts:
          type: array
          items: { $ref: '#/components/schemas/Contract' }
        options_note: { type: string, nullable: true }
        rejected_contracts:
          type: array
          items:
            type: object
            properties:
              symbol: { type: string }
              reason: { type: string }
              message: { type: string, nullable: true }
        plan_layers: { $ref: '#/components/schemas/PlanLayers' }
        risk_block:
          $ref: '#/components/schemas/RiskBlock'
          nullable: true
        execution_rules:
          $ref: '#/components/schemas/ExecutionRules'
          nullable: true
        source_paths:
          type: object
          additionalProperties: { type: string }
        meta:
          type: object
          nullable: true
          description: Additional metadata flags (e.g., `simulated_open`).
        waiting_for:
          type: string
          nullable: true
          description: "Conditional trigger mirrored from the top-level WAIT plan response."
        actionable_now: { type: boolean, nullable: true }
        actionable_soon: { type: boolean, nullable: true }
        entry_anchor: { type: string, nullable: true }
        entry_actionability: { type: number, format: double, nullable: true }
        actionability_gate: { type: number, format: double, nullable: true }
        strategy_profile:
          type: object
          nullable: true
          properties:
            name: { type: string }
            trigger:
              type: array
              items: { type: string }
            invalidation: { type: string }
            management: { type: string }
            reload: { type: string, nullable: true }
            runner: { type: string, nullable: true }
            badges:
              type: array
              items: { type: string }
        badges:
          type: array
          items:
            type: object
            properties:
              label: { type: string }
              kind: { type: string }
      example:
        plan_id: "AAPL-INTRADAY-20251017"
        version: 2
        trade_detail: "https://trading-coach-production.up.railway.app/tv?plan_id=AAPL-INTRADAY-20251017&plan_version=2&interval=5m"
        warnings: []
        planning_context: frozen
        symbol: AAPL
        style: intraday
        bias: long
        entry: 188.42
        stop: 185.9
        targets: [189.8, 191.2, 192.4]
        entry_anchor: ORL
        entry_actionability: 0.91
        actionable_now: false
        actionable_soon: true
        waiting_for: "Reclaim ORL @ 188.42 on 1m close + confirming volume"
        actionability_gate: 0.4
        target_meta:
          - label: TP1
            prob_touch: 0.62
            prob_touch_raw: 0.62
            prob_touch_calibrated: 0.59
            distance: 1.38
            rr_multiple: 1.6
            em_fraction: 0.46
            snap_tag: VAH
          - label: TP2
            prob_touch: 0.48
            prob_touch_raw: 0.48
            prob_touch_calibrated: 0.45
            distance: 2.78
            rr_multiple: 2.0
        targets_meta:
          - label: TP1
            prob_touch: 0.62
            prob_touch_raw: 0.62
            prob_touch_calibrated: 0.59
            distance: 1.38
            rr_multiple: 1.6
            em_fraction: 0.46
            snap_tag: VAH
          - label: TP2
            prob_touch: 0.48
            prob_touch_raw: 0.48
            prob_touch_calibrated: 0.45
            distance: 2.78
            rr_multiple: 2.0
        rr_to_t1: 1.6
        confidence: 0.78
        confluence: ["EMA stack", "VWAP reclaim"]
        accuracy_levels: ["EM cap"]
        tp_reasons:
          - label: TP1
            reason: "Snapped to VAH"
            source: pdh
        options_contracts: []
        rejected_contracts:
          - symbol: "AAPL 2025-10-17 190C"
            reason: SPREAD_TOO_WIDE
            message: "spread 12.5% exceeds limit 8.0%"
        plan_layers: { plan_id: AAPL-INTRADAY-20251017 }
        risk_block:
          risk_points: 2.52
          reward_to_target: { tp1: 1.6 }
          atr_stop_multiple: 1.2
        execution_rules:
          trigger: "Break above VAH"
        data_quality:
          series_present: true
          iv_present: true
          earnings_present: false
          expected_move: 4.5
          remaining_atr: 3.1
          em_used: true
        runner_policy:
          fraction: 0.2
          atr_trail_mult: 0.8
          atr_trail_step: 0.4
          notes: ["Runner fraction adjusted"]
        snap_trace:
          - "stop:185.90->185.80 via swing_low"
          - "tp1:189.20->189.80 via VAH"
        expected_move: 4.5
        remaining_atr: 3.1
        em_used: true
        strategy_profile:
          name: "Power Hour Continuation"
          trigger:
            - "3–4pm ET, price above/below session VWAP"
            - "Short EMAs stacked in trade direction with rising ADX"
          invalidation: "Close back through VWAP or ADX rollover below threshold."
          management: "Trim into prior high/low liquidity; trail into the close."
          reload: "Avoid re-entries after 3:45pm ET unless fresh VWAP reclaim."
          runner: "Tighten to 0.6× ATR once TP1 hits."
          badges: ["Power Hour"]
        badges:
          - { label: "Power Hour Continuation", kind: "strategy" }
          - { label: "Power Hour", kind: "strategy" }
          - { label: "Intraday", kind: "style" }
          - { label: "Long", kind: "bias" }
        calibration_meta:
          style: intraday
          cohort: open_session
          sample_size: 128
          brier_score: 0.147
          ece: 0.052
          bins:
            - lower: 0.4
              upper: 0.6
              count: 58
              avg_prediction: 0.52
              observed: 0.49
        source_paths:
          entry: geometry_engine
          stop: geometry_engine
          targets: geometry_engine
        target_profile:
          entry: 188.42
          stop: 185.9
          targets: [189.8, 191.2, 192.4]
          probabilities: { tp1: 0.62, tp2: 0.48, tp3: 0.31 }
          entry_anchor: ORL
          entry_actionability: 0.91
          actionable_now: false
          actionable_soon: true
          waiting_for: "Reclaim ORL @ 188.42 on 1m close + confirming volume"
          actionability_gate: 0.4
          expected_move: 4.5
          em_used: 1.0
          atr_used: 1.32
          snap_trace: ["tp1 snapped to VAH"]
          warnings: []

    StructuredPlan:
      type: object
      required: [plan_id, symbol, entry, stop, targets]
      properties:
        plan_id: { type: string }
        symbol: { type: string }
        style: { type: string, nullable: true }
        direction: { type: string, nullable: true }
        entry:
          type: object
          required: [type, level]
          properties:
            type: { type: string }
            level:
              type: number
              format: double
              nullable: true
        invalid: { type: boolean }
        stop: { type: number, format: double }
        targets:
          type: array
          items: { type: number, format: double }
        entry_anchor: { type: string, nullable: true }
        entry_actionability: { type: number, format: double, nullable: true }
        actionable_now: { type: boolean, nullable: true }
        actionable_soon: { type: boolean, nullable: true }
        waiting_for:
          type: string
          nullable: true
          description: "Conditional trigger that must be satisfied before the WAIT plan becomes actionable."
        actionability_gate: { type: number, format: double, nullable: true }
        probabilities:
          type: object
          additionalProperties: { type: number, format: double }
        runner: { type: object, nullable: true }
        runner_policy: { type: object, nullable: true }
        confluence:
          type: array
          items: { type: string }
        confidence: { type: number, format: double, nullable: true }
        rationale: { type: string, nullable: true }
        options: { type: object, nullable: true }
        em_used: { type: boolean, nullable: true }
        atr_used: { type: number, format: double, nullable: true }
        expected_move: { type: number, format: double, nullable: true }
        remaining_atr: { type: number, format: double, nullable: true }
        style_horizon_applied: { type: string, nullable: true }
        chart_url: { type: string, format: uri, nullable: true }
        as_of: { type: string, format: date-time, nullable: true }
        snap_trace:
          type: array
          items: { type: string }
        meta:
          type: array
          items: { type: object }
        target_meta:
          type: array
          items: { $ref: '#/components/schemas/TargetMeta' }
        tp_reasons:
          type: array
          items: { $ref: '#/components/schemas/TpReason' }
        key_levels_used:
          $ref: '#/components/schemas/KeyLevelsUsed'
          nullable: true
        mtf_confluence:
          type: array
          items: { type: string }
          nullable: true
        risk_block:
          $ref: '#/components/schemas/RiskBlock'
          nullable: true
        execution_rules:
          $ref: '#/components/schemas/ExecutionRules'
          nullable: true

    TargetProfile:
      type: object
      required: [entry, stop, targets, probabilities, snap_trace, meta, warnings]
      properties:
        entry:
          type: number
          format: double
          nullable: true
        stop:
          type: number
          format: double
          nullable: true
        targets:
          type: array
          items: { type: number, format: double }
        probabilities:
          type: object
          additionalProperties: { type: number, format: double }
        entry_anchor: { type: string, nullable: true }
        entry_actionability: { type: number, format: double, nullable: true }
        actionable_now: { type: boolean, nullable: true }
        actionable_soon: { type: boolean, nullable: true }
        waiting_for:
          type: string
          nullable: true
          description: >-
            Conditional trigger text for WAIT plans. When present the response omits
            fixed entry/stop values and relies on this instruction.
        actionability_gate: { type: number, format: double, nullable: true }
        expected_move: { type: number, format: double, nullable: true }
        em_used: { type: boolean, nullable: true }
        atr_used: { type: number, format: double, nullable: true }
        snap_trace:
          type: array
          items: { type: string }
        meta:
          type: array
          items: { type: object }
        warnings:
          type: array
          items: { type: string }
        runner: { type: object, nullable: true }
        bias: { type: string, nullable: true }
        style: { type: string, nullable: true }

    EventsBlock:
      type: object
      nullable: true
      properties:
        next_fomc_minutes: { type: integer, nullable: true }
        next_cpi_minutes: { type: integer, nullable: true }
        next_nfp_minutes: { type: integer, nullable: true }
        within_event_window: { type: boolean, nullable: true }
        label: { type: string, nullable: true }

    EarningsBlock:
      type: object
      nullable: true
      properties:
        next_earnings_at: { type: string, format: date-time, nullable: true }
        dte_to_earnings: { type: integer, nullable: true }
        pre_or_post: { type: string, nullable: true }
        earnings_flag: { type: string, nullable: true }
        expected_move_pct: { type: number, format: double, nullable: true }

    SessionState:
      type: object
      nullable: true
      properties:
        status: { type: string, enum: [open, closed] }
        as_of: { type: string, format: date-time }
        next_open: { type: string, format: date-time, nullable: true }
        tz: { type: string, default: America/New_York }
        banner: { type: string }
